#!/bin/sh

#-------------------------------------------------------------------------------
# Copyright 2018-2019 Dominik Salvet
# SPDX-License-Identifier: MIT
# https://github.com/dominiksalvet/vhdldep
#-------------------------------------------------------------------------------
# DESCRIPTION:
#   This file represents vhdldep - simple VHDL dependency generator.
# PARAMETERS:
#   All given arguments are processed as vhdldep's help describes.
#-------------------------------------------------------------------------------


#-------------------------------------------------------------------------------
# SOFTWARE DEPENDENCIES
#-------------------------------------------------------------------------------

# list of required software
SW_DEPS='command echo sed ['

# check if some software is missing
for sw in $SW_DEPS; do
    # software is missing if at least one piece of software is missing
    if ! command -v -- "$sw" > /dev/null; then
        echo "$0: missing $sw software" >&2
        exit 1
    fi
done

#-------------------------------------------------------------------------------
# DEFINITIONS
#-------------------------------------------------------------------------------

# the current version of vhdldep
VERSION=1.1.0

HELP_MESSAGE="USAGE:
  $0 [OPTION...] FILE...
  $0 COMMAND

OPTION:
  -object-dir=DIR  object files directory path

COMMAND:
  help   show this help
  about  show information"

ABOUT_MESSAGE="vhdldep $VERSION
Simple VHDL dependency generator.

Copy"'right 2018-2019 Dominik Salvet
SPDX License Identifier: MIT
https://github.com/dominiksalvet/vhdldep'

HINT_MESSAGE="Try '$0 help' for getting help."

# normalize a path (removes only unnecessary slashes "/")
NORMALIZE_PATH='s|/\+|/|g'

# in case of existing spaces, setup persisting spaces for one more sed processing
SETUP_PERSIST_SPACES='s/ /\\\\ /g'

# get object directory path, normalize it and set up persist spaces
GET_OBJECT_DIR_PATH='
s|^-object-dir=||
s|$|/|
'"$NORMALIZE_PATH"'
'"$SETUP_PERSIST_SPACES"'
'

# function to add a file to the list of current ones
add_file() {
    # normalize the path
    norm_path=$(echo "$1" | sed -e "$NORMALIZE_PATH")

    if [ -z "$file_list" ]; then
        file_list="$norm_path"
    else
        # the file path may contain spaces, it is required to use a different delimiter
        file_list="$file_list
$norm_path"
    fi
}

#-------------------------------------------------------------------------------
# PROCESSING PARAMETERS
#-------------------------------------------------------------------------------

# next parameters are only file names
file_names_only=false

# processing each parameter
for i in "$@"; do
    if [ "$file_names_only" = true ]; then
        add_file "$i"
    else
        case "$i" in
            -object-dir=?*)
                # get the DIR path from this parameter
                object_dir=$(echo "$i" | sed -e "$GET_OBJECT_DIR_PATH")
                ;;
            --)
                file_names_only=true
                ;;
            help)
                echo "$HELP_MESSAGE"
                exit 0
                ;;
            about)
                echo "$ABOUT_MESSAGE"
                exit 0
                ;;
            -*)
                echo "$0: The option '$i' was not recognized.
$HINT_MESSAGE" >&2
                exit 1
                ;;
            *)
                add_file "$i"
                ;;
        esac
    fi
done

# check if any argument with file path provided
if [ -z "$file_list" ]; then
    echo "$0: No argument with file path provided.
$HINT_MESSAGE" >&2
    exit 1
fi

# change internal field separator, namely for use in the following for loops
IFS='
'

# check if files in the list exist
for i in $file_list; do
    if [ ! -f "$i" ]; then
        echo "$0: Can not open the '$i' file." >&2
        exit 1
    fi
done

#-------------------------------------------------------------------------------
# VHDL FILES ANALYSIS
#-------------------------------------------------------------------------------

GET_TARGET='
s|^.*/||
s/\..*/.o/
s|^|'"$object_dir"'|
'

REMOVE_COMMENTS='s/--.*$//'

ALL_TO_LOWER_CASE='s/.*/\L&/'

GET_USES='
/^\s*use\s.*\;/b
/^\s*use\s/,/\;/!d
'

ONE_USE_PER_LINE='
/use/!b
:next
/\;/bdone
N
bnext
:done
s/\n//g
'

ONE_LOCAL_USE_DEPENDENCY_PER_LINE='
s/use//
s/\s*//g
/^ieee\|^std/d
s/\;$//
s/\.all$//
s/^.*\.//
s/$/\.o/
s|^|'"$object_dir"'|
'

LOCAL_USE_DEPENDENCIES='
:next
$bdone
N
bnext
:done
s/\n/ /g
'

for i in $file_list; do

    target=$(
    echo "$i" |
    sed -e "$GET_TARGET"
    )

    sed_result=$(
    sed -e "$REMOVE_COMMENTS" \
        -e "$ALL_TO_LOWER_CASE" \
        -e "$GET_USES" \
        -- "$i" |
    sed -e "$ONE_USE_PER_LINE" \
        -e "$ONE_LOCAL_USE_DEPENDENCY_PER_LINE" |
    sed -e "$LOCAL_USE_DEPENDENCIES"
    )

    echo "$target: $(echo "$i" | sed -e "$SETUP_PERSIST_SPACES") $sed_result"

done
